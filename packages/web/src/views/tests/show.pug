//- extends ../layout
extends ../base.pug

mixin toggles
  button(class="toggler flex items-center text-left pl-4 ml-auto justify-end"  data-toggle)
    span(class="icon inline-block text-3xl") ⌃

mixin test(test)
  div(class=`test loading`)
    div(class=`flex items-center flex-row`)
      div(class="py-5 flex items-center")
        if test.passed
          img(src="/img/green_dot.svg" class="mr-4")
        else
          img(src="/img/red_dot.svg" class="mr-4")
        p(class="ml-2 font-bold")= test.title
      img(src="/img/loading.svg" class="spinner")

    div(class="test__description ml-12")
      | !{md.render(test.description)}

mixin result_summary
  div(class="test__summary mr-0 sm:mr-4 px-2 sm:px-16")
    block

mixin group_index(index)
  if (index%2 === 0)
    section(class="test-group bg-lightGray p-4 sm:p-6 rounded-lg")
      block 
  else 
    section(class="test-group p-4 sm:p-6 rounded-lg")
      block 


block body
  include ../partials/header.pug
  include ../partials/search_bar.pug
  div(class="max-w-5xl lg:w-full mx-6 md:mx-16 lg:mx-auto mt-2 sm:mt-28 flex-grow flex flex-col")
    div(class="flex flex-col mb-16")
      h1(class="mt-8")
        | Resultat för #{domain.domain_name}

    div(class="results flex flex-col mb-12")
      - var i =0
      each group in groups
        +group_index(i++)
          div(class="flex flex-row items-center")
            if group.result.success 
              img(src="/img/robust_symbol_green.svg" class="mr-4")
            else
              img(src="/img/robust_symbol_red.svg" class="mr-4")
            div(class="flex flex-col")
              h2= group.title 
              p(class="mt-1")= group.description
            +toggles
          +result_summary
            h4 
              | <b>Resultat: </b>
              = group.result.description


            each test in group.tests
              +test(test)

  div(class="bg-black w-full py-24")
    +searchBar("Testa en annan sajt")
        
block script
  script(type="application/javascript").
    const tests = document.querySelectorAll('.test-group > .test')
    const groups = document.querySelectorAll('.test-group')
    for (const group of groups) {
      const togglers = group.querySelectorAll('[data-toggle]')
      const queue = Array.from(group.querySelectorAll('.test.loading'))
      for (const t of togglers) {
        t.addEventListener('click', function() {
          console.log('clicked', group.classList)
          if (!group.classList.contains('loading'))
            group.classList.toggle('open')
        })
      }
      console.log(queue)

      const MAX_TIME = 1000
      const MIN_TIME = 500

      function pop() {
        if (queue.length === 0) return
        const test = queue.shift()
        setTimeout(
          () => {
            test.classList.remove('loading')
            test.querySelector('img.spinner').remove()
            pop()
          },
          Math.random() * (MAX_TIME - MIN_TIME) + MIN_TIME
        )
      }
      pop()
    }